name: Build & Deploy (Cloud Run)

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  REGION: ${{ vars.REGION }}
  REPO_NAME: laundry
  API_SERVICE: laundry-api
  FRONTEND_SERVICE: laundry-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker auth
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # Explicit login fixes "Unauthenticated request" on docker push
      - name: Docker login to Artifact Registry
        run: |
          gcloud auth print-access-token | \
          docker login -u oauth2accesstoken --password-stdin https://${{ env.REGION }}-docker.pkg.dev

      # Optional (kept for completeness; safe to leave)
      - name: Configure Docker auth
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # ---------- API ----------
      - name: Build & Push API
        run: |
          API_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.API_SERVICE }}:${{ github.sha }}
          docker build -t "$API_IMAGE" ./api
          docker push "$API_IMAGE"
          echo "API_IMAGE=$API_IMAGE" >> $GITHUB_ENV

      - name: Deploy API
        run: |
          gcloud run deploy ${{ env.API_SERVICE }} \
            --image "$API_IMAGE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 --memory 512Mi
          API_URL=$(gcloud run services describe ${{ env.API_SERVICE }} --region "${{ env.REGION }}" --format='value(status.url)')
          echo "API_URL=$API_URL" >> $GITHUB_ENV

      # ---------- Frontend ----------
      - name: Build & Push Frontend
        run: |
          FE_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          docker build -t "$FE_IMAGE" ./laundry-frontend
          docker push "$FE_IMAGE"
          echo "FE_IMAGE=$FE_IMAGE" >> $GITHUB_ENV

      - name: Deploy Frontend
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image "$FE_IMAGE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 --memory 512Mi \
            --set-env-vars "NEXT_PUBLIC_API_BASE=${{ env.API_URL }}"
