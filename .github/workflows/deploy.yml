name: Build & Deploy (Cloud Run)

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ vars.PROJECT_ID }}           # onembyte-laundry-latinto
  REGION: ${{ vars.REGION }}                   # southamerica-east1
  REPO_NAME: laundry
  API_SERVICE: laundry-api                     # (unused for now)
  FRONTEND_SERVICE: laundry-frontend
  DB_INSTANCE: laundry-db
  DB_NAME: laundry
  DB_USER: laundry_app
  DB_INSTANCE_CONN: ${{ vars.PROJECT_ID }}:${{ vars.REGION }}:laundry-db
  DB_SKIP_CREATE: ${{ vars.DB_SKIP_CREATE || 'false' }}   # set to 'true' to skip instance/db/user creation
  

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ---------- Database ----------
      - name: Enable Cloud SQL Admin API
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
        run: |
          set -euo pipefail
          gcloud services enable sqladmin.googleapis.com --project "$PROJECT_ID"

      - name: Ensure Cloud SQL Postgres (smallest)
        if: env.DB_SKIP_CREATE != 'true'
        env:
          INSTANCE: ${{ env.DB_INSTANCE }}
          REGION: ${{ env.REGION }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
        run: |
          set -euo pipefail
          if gcloud sql instances describe "$INSTANCE" --project "$PROJECT_ID" >/dev/null 2>&1; then
            echo "Cloud SQL instance $INSTANCE already exists."
          else
            echo "Creating Cloud SQL instance $INSTANCE (attempt shared-core smallest, fallback to smallest custom)..."
            set +e
            gcloud sql instances create "$INSTANCE" \
              --project "$PROJECT_ID" \
              --database-version=POSTGRES_15 \
              --tier=db-f1-micro \
              --region="$REGION" \
              --storage-size=10 \
              --availability-type=zonal \
              --storage-auto-increase \
              --quiet
            STATUS=$?
            set -e
            if [ $STATUS -ne 0 ]; then
              echo "Shared-core tier unavailable; falling back to custom smallest (1 vCPU, 3.75GB)."
              gcloud sql instances create "$INSTANCE" \
                --project "$PROJECT_ID" \
                --database-version=POSTGRES_15 \
                --tier=db-custom-1-3840 \
                --region="$REGION" \
                --storage-size=10 \
                --availability-type=zonal \
                --storage-auto-increase \
                --quiet
            fi
          fi

      - name: Ensure database and user
        if: env.DB_SKIP_CREATE != 'true'
        env:
          INSTANCE: ${{ env.DB_INSTANCE }}
          DB_NAME: ${{ env.DB_NAME }}
          DB_USER: ${{ env.DB_USER }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -euo pipefail
          # Wait for instance to be ready (simple poll)
          for i in {1..20}; do
            STATE=$(gcloud sql instances describe "$INSTANCE" --project "$PROJECT_ID" --format="value(state)" 2>/dev/null || true)
            if [ "$STATE" = "RUNNABLE" ]; then
              break
            fi
            echo "Waiting for instance to be runnable (current: $STATE)..."
            sleep 10
          done
          if [ "$STATE" != "RUNNABLE" ]; then
            echo "Instance not ready, aborting."
            exit 1
          fi

          if ! gcloud sql databases describe "$DB_NAME" --instance "$INSTANCE" --project "$PROJECT_ID" >/dev/null 2>&1; then
            gcloud sql databases create "$DB_NAME" --instance "$INSTANCE" --project "$PROJECT_ID"
          else
            echo "Database $DB_NAME already exists."
          fi

          if gcloud sql users list --instance "$INSTANCE" --project "$PROJECT_ID" --format="value(name)" | grep -qx "$DB_USER"; then
            gcloud sql users set-password "$DB_USER" --host="%" --instance "$INSTANCE" --project "$PROJECT_ID" --password="$DB_PASSWORD"
          else
            gcloud sql users create "$DB_USER" --host="%" --instance "$INSTANCE" --project "$PROJECT_ID" --password="$DB_PASSWORD"
          fi

      - name: Start Cloud SQL Proxy
        env:
          DB_CONN: ${{ env.DB_INSTANCE_CONN }}
        run: |
          set -euo pipefail
          PROXY_VERSION=2.10.1
          curl -sSfL "https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v${PROXY_VERSION}/cloud-sql-proxy.linux.amd64" -o cloud-sql-proxy
          chmod +x cloud-sql-proxy
          # Use ADC from the auth step (GOOGLE_APPLICATION_CREDENTIALS)
          ./cloud-sql-proxy "$DB_CONN" --port 5432 --address 127.0.0.1 --credentials-file "$GOOGLE_APPLICATION_CREDENTIALS" &
          sleep 5

      - name: Apply database schema
        env:
          DB_USER: ${{ env.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ env.DB_NAME }}
        run: |
          set -euo pipefail
          PSQL="psql \"host=127.0.0.1 port=5432 user=${DB_USER} password=${DB_PASSWORD} dbname=${DB_NAME}\""
          eval $PSQL -f api/db/schema.sql

      ############################################
      # API build/deploy
      ############################################
      - name: Build & Push API image
        run: |
          API_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.API_SERVICE }}:${{ github.sha }}
          docker build -t "$API_IMAGE" ./api
          docker push "$API_IMAGE"
          echo "API_IMAGE=$API_IMAGE" >> $GITHUB_ENV

      - name: Deploy API to Cloud Run
        env:
          DB_CONN: ${{ env.DB_INSTANCE_CONN }}
          DB_USER: ${{ env.DB_USER }}
          DB_NAME: ${{ env.DB_NAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          gcloud run deploy ${{ env.API_SERVICE }} \
            --image "$API_IMAGE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 --memory 512Mi \
            --add-cloudsql-instances "$DB_CONN" \
            --set-env-vars DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@/${DB_NAME}?host=/cloudsql/${DB_CONN}" \
            --set-env-vars DB_POOL_MIN=1,DB_POOL_MAX=5 \
            --traffic latest=100

      # ---------- Frontend ----------
      - name: Build & Push Frontend image
        run: |
          FE_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          docker build -t "$FE_IMAGE" ./laundry-frontend
          docker push "$FE_IMAGE"
          echo "FE_IMAGE=$FE_IMAGE" >> $GITHUB_ENV

      # ---------- Deploy ----------
      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image "$FE_IMAGE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 --memory 512Mi
