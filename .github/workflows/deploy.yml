name: Build & Deploy (Cloud Run)

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ vars.PROJECT_ID }}           # onembyte-laundry-latinto
  REGION: ${{ vars.REGION }}                   # southamerica-east1
  REPO_NAME: laundry
  API_SERVICE: laundry-api                     # (unused for now)
  FRONTEND_SERVICE: laundry-frontend
  

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_CONFIG: ${{ runner.temp }}/.docker
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker login to Artifact Registry
        run: |
          gcloud auth print-access-token | \
          docker login -u oauth2accesstoken --password-stdin https://${{ env.REGION }}-docker.pkg.dev

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true  # auto-logout in post-step

      ############################################
      # API build/deploy (disabled for now)
      ############################################
      # - name: Build & Push API image
      #   run: |
      #     API_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.API_SERVICE }}:${{ github.sha }}
      #     docker build -t "$API_IMAGE" ./api
      #     docker push "$API_IMAGE"
      #     echo "API_IMAGE=$API_IMAGE" >> $GITHUB_ENV
      #
      # - name: Deploy API to Cloud Run
      #   run: |
      #     gcloud run deploy ${{ env.API_SERVICE }} \
      #       --image "$API_IMAGE" \
      #       --region "${{ env.REGION }}" \
      #       --platform managed \
      #       --allow-unauthenticated \
      #       --port 8080 \
      #       --cpu 1 --memory 512Mi \
      #       --traffic latest=100

      # ---------- Frontend ----------
      # ---------- Build ----------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Frontend (cached)
        run: |
          FE_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          docker buildx build \
            --cache-from=type=registry,ref=${FE_IMAGE}-cache \
            --cache-to=type=registry,ref=${FE_IMAGE}-cache,mode=max \
            -t "${FE_IMAGE}" ./laundry-frontend
          docker push "${FE_IMAGE}"

      # ---------- Deploy ----------
      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image "$FE_IMAGE" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 --memory 512Mi
      
      # ---------- Clean cred ----------
      - name: Cleanup Docker creds
        if: always()
        run: rm -f "$DOCKER_CONFIG/config.json"
